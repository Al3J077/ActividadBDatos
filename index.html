<!DOCTYPE html>
<html lang="es">
  <head>
    <title>Estado de √Ånimo y Canciones</title>
  </head>
  <body>
    <h1>Selecciona tu estado de √°nimo</h1>
    <input type="text" id="nombreUsuario" placeholder="Ingresa tu nombre" />
    <select id="estadoAnimo">
      <option value="feliz">Feliz</option>
      <option value="triste">Triste</option>
      <option value="relajado">Relajado</option>
      <option value="enojado">Enojado</option>
    </select>
    <button id="guardarEstado">Guardar Estado</button>

    <h2 id="tituloCancion" style="display: none">Canci√≥n Recomendada:</h2>
    <p id="cancionRecomendada" style="display: none"></p>
    <iframe
      id="player"
      style="display: none"
      width="560"
      height="315"
      frameborder="0"
      allowfullscreen
    ></iframe>

    <h2>√öltimos estados guardados</h2>
    <ul id="listaEstados"></ul>

    <h2>Autenticaci√≥n</h2>
    <input type="email" id="email" placeholder="Correo electr√≥nico" />
    <input type="password" id="password" placeholder="Contrase√±a" />
    <button id="registrarse">Registrarse</button>
    <button id="iniciarSesion">Iniciar Sesi√≥n</button>
    <button id="cerrarSesion" style="display: none">Cerrar Sesi√≥n</button>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-app.js";
      import {
        getFirestore,
        collection,
        addDoc,
        onSnapshot,
        deleteDoc,
        doc,
      } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-firestore.js";
      import {
        getAuth,
        createUserWithEmailAndPassword,
        signInWithEmailAndPassword,
        signOut,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-auth.js";

      const firebaseConfig = {
        apiKey: "AIzaSyBVNQysEQse3mXOzrn95qKCew-4Y5bU_m0",
        authDomain: "actividadbdatos-3e9ba.firebaseapp.com",
        projectId: "actividadbdatos-3e9ba",
        storageBucket: "actividadbdatos-3e9ba.appspot.com",
        messagingSenderId: "891278365050",
        appId: "1:891278365050:web:b724f2270dfe62ff4d46c3",
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth(app);

      const canciones = {
        feliz: {
          nombre: "Happy - Pharrell Williams",
          url: "https://www.youtube.com/embed/ZbZSe6N_BXs",
        },
        triste: {
          nombre: "Someone Like You - Adele",
          url: "https://www.youtube.com/embed/hLQl3WQQoQ0",
        },
        relajado: {
          nombre: "Weightless - Marconi Union",
          url: "https://www.youtube.com/embed/UfcAVejslrU",
        },
        enojado: {
          nombre: "Break Stuff - Limp Bizkit",
          url: "https://www.youtube.com/embed/ZpUYjpKg9KY",
        },
      };

      document
        .getElementById("guardarEstado")
        .addEventListener("click", async () => {
          const nombre = document.getElementById("nombreUsuario").value;
          const estado = document.getElementById("estadoAnimo").value;
          const user = auth.currentUser;

          if (!user) {
            alert("Debes iniciar sesi√≥n para guardar tu estado de √°nimo.");
            return;
          }

          if (!nombre) {
            alert("Por favor, ingresa tu nombre.");
            return;
          }

          try {
            await addDoc(collection(db, "estadosAnimo"), {
              nombre,
              estado,
              userId: user.uid,
            });
            document.getElementById("tituloCancion").style.display = "block";
            document.getElementById("cancionRecomendada").style.display =
              "block";
            document.getElementById(
              "cancionRecomendada"
            ).innerText = `Canci√≥n: ${canciones[estado].nombre}`;
            document.getElementById("player").style.display = "block";
            document.getElementById("player").src = canciones[estado].url;
          } catch (error) {
            console.error("‚ùå Error al guardar en Firebase:", error);
          }
        });

      onSnapshot(collection(db, "estadosAnimo"), (snapshot) => {
        const lista = document.getElementById("listaEstados");
        lista.innerHTML = "";
        snapshot.forEach((docSnap) => {
          const li = document.createElement("li");
          li.textContent = `${docSnap.data().nombre} est√° ${
            docSnap.data().estado
          }`;

          const btnEliminar = document.createElement("button");
          btnEliminar.textContent = "Eliminar";
          btnEliminar.addEventListener("click", async () => {
            await deleteDoc(doc(db, "estadosAnimo", docSnap.id));
          });

          li.appendChild(btnEliminar);
          lista.appendChild(li);
        });
      });

      document
        .getElementById("registrarse")
        .addEventListener("click", async () => {
          const email = document.getElementById("email").value;
          const password = document.getElementById("password").value;
          try {
            await createUserWithEmailAndPassword(auth, email, password);
            alert("‚úÖ Registro exitoso");
          } catch (error) {
            alert(`‚ùå Error: ${error.message}`);
          }
        });

      document
        .getElementById("iniciarSesion")
        .addEventListener("click", async () => {
          const email = document.getElementById("email").value;
          const password = document.getElementById("password").value;
          try {
            await signInWithEmailAndPassword(auth, email, password);
            alert("‚úÖ Sesi√≥n iniciada");
          } catch (error) {
            alert(`‚ùå Error: ${error.message}`);
          }
        });

      document
        .getElementById("cerrarSesion")
        .addEventListener("click", async () => {
          await signOut(auth);
          alert("üëã Sesi√≥n cerrada");
          document.getElementById("player").style.display = "none";
        });

      onAuthStateChanged(auth, (user) => {
        document.getElementById("cerrarSesion").style.display = user
          ? "block"
          : "none";
      });
    </script>
  </body>
</html>
